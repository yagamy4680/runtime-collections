# Design for Runtime-Collections

## Directory Layout

### Top-Level

```text
    /README.md         -> readme
    
    /DESIGN.md         -> design document
    
    /scripts           -> all script files

    /nodejs            -> nodejs runtimes and modules for different architectures
        /runtimes
        /modules
		  
    /python            -> python runtimes
        /runtimes
```


### NodeJS Overall

The nodejs runtimes are packed by [nodenv](https://github.com/OiNutter/nodenv) for different versions, architectures, and distributions. 

```text
  /nodejs                     -> top-level of nodejs runtimes
    /runtimes
      /Linux-Ubuntu-trusty    -> {{Kernel}}-{{DistributionName}}-{{DistributionCodename}}
        /x86_64               -> {{Architecture}}
        
          /20150701a          -> runtime version, a simple date string
            /configs          -> configurations for building this nodejs
            /config.json      -> nodejs system configurations
            /build.log        -> logs of building this nodejs
            /.nodenv          -> nodenv container of the nodejs
            
          /20150701b
            /...
          /20150701c
            /...
          /20150702a
            /...
            
        /armv7l
          /20150701
          /20150702

      /Linux-Ubuntu-utopic
      /Linux-Ubuntu-vivid
      /Linux-Debian-wheezy
      /Linux-Debian-jessie


    /modules
      /Linux-Ubuntu-trusty
        /x86_64                 -> {{Architecture}}
          /0.10.38              -> nodejs version
            /noble              -> module name
              /0.1.0            -> module version
              /0.2.1
            /noble-device
              /0.3.0
              /0.9.7
        /armv7l
```

Here are the explanations for above varables:

| variable | command | sample values |
|---|---|---|
| Kernel | `uname -s` | `Linux`, `Darwin` |
| DistributionName | `lsb_release -a | grep "^Distributor" | awk '{print $3}'` | `Ubuntu`, `Debian` |
| DistributionCodename | `lsb_release -a | grep "^Codename" | awk '{print $2}'` | `utopic`, `trusty`, `wheezy` |
| Architecture | `uname -m` | `x86_64`, `arm7l`, `mips4` |


### NodeJS Runtime (E.g. 20150701a)

Taking __20150701a__ as example, here are the details of its directory structure:

```text
    /20150701a
        /configs
        /config.json
        /build.log
        /.nodenv
            /bin
            /shims
            /src
            /versions
                /0.10.38
```

The nodejs runtime __20150701a__ is based on nodejs `0.10.38`.

`configs` file stores all information of building this nodejs runtime, including:

- CONFIGURE_OPTS
- CFLAGS
- CXXFLAGS
- OS_XXX (os related environment variables)
- nodejs version
- npm version
- nodejs built-in modules (e.g. [livescript](http://livescript.net/), [coffeescript](http://coffeescript.org/), [pm2](https://github.com/Unitech/pm2), ...)

```bash
# OS Settings
#
OS_KERNEL Linux
OS_DIST_NAME  Ubuntu
OS_DIST_CODENAME  trusty
OS_ARCHITECTURE x86_64

# Build Settings
#
CONFIGURE_OPTS  "--shared-zlib "
CFLAGS  " "
CXXFLAGS  " "

# NodeJS
#
nodejs  version iojs-2.2.1
npm version 2.11.0

# NodeJS built-in modules
#
module  livescript  1.4.0
module  coffee-script 1.9.3
module  pm2 0.14.3
```

`config.json` file stores the configure options that were used to compile the current node executable. The file is generated by executing this command: `node -p process.config`. Here is one example:

```json
{ target_defaults:
   { cflags: [],
     default_configuration: 'Release',
     defines: [],
     include_dirs: [],
     libraries: [ '-lz' ] },
  variables:
   { gas_version: '2.24',
     host_arch: 'x64',
     icu_small: false,
     node_install_npm: true,
     node_prefix: '/root/.nodenv/versions/iojs-2.2.1',
     node_shared_http_parser: false,
     node_shared_libuv: false,
     node_shared_openssl: false,
     node_shared_zlib: true,
     node_tag: '',
     node_use_dtrace: false,
     node_use_etw: false,
     node_use_lttng: false,
     node_use_openssl: true,
     node_use_perfctr: false,
     openssl_no_asm: 0,
     python: '/usr/bin/python',
     target_arch: 'x64',
     uv_parent_path: '/deps/uv/',
     uv_use_dtrace: false,
     v8_enable_gdbjit: 0,
     v8_enable_i18n_support: 0,
     v8_no_strict_aliasing: 1,
     v8_optimized_debug: 0,
     v8_random_seed: 0,
     v8_use_snapshot: 1,
     want_separate_host_toolset: 0 } }
```

`build.log` file contains all building logs for compiling the current node executable.